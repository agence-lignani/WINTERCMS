<?php
$hits  = $results['hits']  ?? [];
$total = $results['total'] ?? 0;

$perPage = (int) \Config::get('agencelignani.pixabaylibrary::per_page', 24);

$page = (int) $page;
if ($page < 1) {
    $page = 1;
}

$totalPages = $perPage > 0 ? (int) ceil($total / $perPage) : 1;
?>

<div class="m-t">
    <p>
        Résultats : <strong><?= count($hits) ?></strong> / <?= (int) $total ?> pour
        <strong><?= e($query) ?></strong>
    </p>
</div>

<div class="row">
    <?php foreach ($hits as $image): ?>
        <?php
            // On utilise webformatURL pour l’import (plus léger que l’original)
            $thumb    = $image['webformatURL'] ?? ($image['previewURL'] ?? '');
            $large    = $thumb;
            $tags     = $image['tags'] ?? '';
            $username = $image['user'] ?? '';
            $id       = $image['id'] ?? '';
            $fileName = 'pixabay-' . $id . '.jpg';
        ?>
        <div class="col-md-3 col-sm-4 col-xs-6 m-b">
            <div class="panel">
                <div class="panel-body" style="padding:8px;">
                    <?php if ($thumb): ?>
                        <img
                            src="<?= e($thumb) ?>"
                            alt="<?= e($tags) ?>"
                            class="img-responsive"
                            style="width:100%;height:180px;object-fit:cover;border-radius:4px;"
                        >
                    <?php else: ?>
                        <div style="width:100%;height:180px;display:flex;align-items:center;justify-content:center;background:#f7f7f7;border-radius:4px;font-size:12px;color:#999;">
                            Prévisualisation indisponible
                        </div>
                    <?php endif; ?>

                    <p class="small m-t-sm">
                        <strong>Photographe :</strong> <?= e($username) ?><br>
                        <span class="text-muted"><?= e($tags) ?></span>
                    </p>

                    <?php if ($large): ?>
                        <button
                            class="btn btn-xs btn-primary btn-block"
                            data-request="onImportImage"
                            data-request-data="image_url: '<?= e($large) ?>', filename: '<?= e($fileName) ?>'"
                            data-stripe-load-indicator
                        >
                            <i class="icon-download"></i> Importer dans Médias
                        </button>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    <?php endforeach; ?>
</div>

<?php if ($totalPages > 1): ?>
    <nav class="text-center m-t">
        <ul class="pagination pagination-sm">
            <?php if ($page > 1): ?>
                <li>
                    <a href="?q=<?= urlencode($query) ?>&page=<?= $page - 1 ?>">
                        &laquo; Précédent
                    </a>
                </li>
            <?php else: ?>
                <li class="disabled"><span>&laquo; Précédent</span></li>
            <?php endif; ?>

            <li class="active">
                <span>Page <?= $page ?> / <?= $totalPages ?></span>
            </li>

            <?php if ($page < $totalPages): ?>
                <li>
                    <a href="?q=<?= urlencode($query) ?>&page=<?= $page + 1 ?>">
                        Suivant &raquo;
                    </a>
                </li>
            <?php else: ?>
                <li class="disabled"><span>Suivant &raquo;</span></li>
            <?php endif; ?>
        </ul>
    </nav>
<?php endif; ?>
